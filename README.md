[![License](https://img.shields.io/github/license/IliyanKostov9/nixos-config)](https://www.gnu.org/licenses/gpl-3.0.en.html)
[![Build Status: Flake](https://img.shields.io/github/actions/workflow/status/IliyanKostov9/nixos-config/flake-checker.yml?branch=master)](https://github.com/IliyanKostov9/nixos-config/actions?query=branch%3Amaster)
[![GitGuardian scan](https://github.com/IliyanKostov9/nixos-config/actions/workflows/gitguardian.yaml/badge.svg?branch=master)](https://github.com/IliyanKostov9/nixos-config/actions/workflows/gitguardian.yaml)
[![Written in Nix](https://img.shields.io/badge/code-nix-blue)](https://nixos.org/)

# ❄️ NixOS configuration ❄️

My personal NixOS configuration file.

It contains hardware/software configurations for setting up my personal/work machines.
As of this moment, I haven't yet reached the point of deploying VMs using Nix, meaning that this configuration **IS INTENDED TO BE USED FOR PERSONAL USE ONLY**.

Please don't try to copy-paste the configuration on your own machine and try to understand it first for the following reasons:

1. It simply won't work, due to the difference in hardware configuration between my machines and yours (for example gpu drivers, device IDs)
2. You won't learn much doing that, and later when you want to change something in your config it'll be harder for you to achieve that
3. This config structure is made by my personal taste, not yours ... and if some certain functionalities are either missing or badly implemented - then you would need to fork my repo and make your desired change in your version. Nevertheless, I'm more than open to suggestions for improvements, so please feel free to open an issue!

Since it will be quite annoying for people to use my configuration and requiring them to find-and-replace all of the hardware specific configuration, spanning different modules, I have centralized all of those dependencies into `config.nix` file. This file contains all user and hardware-specific configurations. It is imported and used in `flake.nix` and downstream modules, it ensures that all of the flake configuration names are 1:1 as in the names, listed at `config.nix`. Also, `flake.nix` will recursively create or remove any flake configuration, depending on which attribute sets you add or remove. In short, you (mostly) only need to interact with `config.nix` when you decide to add or remove any user or host machine. 

One thing to be careful is to comply with the module structure. For example say you create a new user, and you add it in `config.nix`, you would then have to create a new directory under: `/home` and place a file `default.nix`. You would also need to create under that `/home/user` directory another several subdirectories, relating to dotfiles, themes and options (see example `/home/ikostov2/`. Lastly, since every user wants to use different programs you would then need to create `user.nix` file under `/programs/user/`.

As for the hosts configuration, it is more flexible, and you would have less chance to screw things up (except if you don't change the bootloader and file System values, of course).
One of my personal annoyances is manually *synchronizing* the presence of the user home-configuration and the system based user configuration. In both cases I need the same username in my home and user for the system to grant me access. So I used that user configuration in both home/hosts configuration by passing them via nix parameters.

In both of these configurations (user/hosts for config.nix) make sure to copy-paste a new attribute set, in case you want to add a new user/hosts, because all the downstream modules rely on that particular structure.

## Used Nix features 

1. home-manager
2. flakes

## Structure

```markdown
.
├── archive
├── CHANGELOG.md
├── config.nix
├── flake.lock
├── flake.nix
├── home
├── hosts
├── LICENSE
├── Makefile
├── programs
├── README.md
└── wallpaper.jpg

5 directories, 8 files
```

- archive: not used in building the system. It stores the initial configuration of NixOS when first installed. (you can ignore this part)
- config.nix: An attribute set, containing all of the user and host tightly specific configuration, that is consumed by the home and hosts module
- flake.lock: autogenerated file when building the system along with an argument of `--flake`. Used for pinning down the specific versions of the Nix dependencies, that are listed under *flake.nix*
- flake.nix: file, used for declaring all of the Nix specific dependencies/features (home-manager, nixpkgs). It is also the starting point for defining all of the the user/system environments
- home: used for storing all of the user environments (Joe's PC, Jane's PC, etc.)
- hosts: used for storing the hardware specifications of the machines
- Makefile: automation script for aliasing the Nix CLI commands in a more user-friendly way
- programs: contains the user/system type of packages
- wallpaper.jpg: background photo for i3wm

## Build instructions

First you can check all of the available build scrpts by using `make help`
After that please make sure to replcae the `DEFAULT_USER` value from Makefile into your liking.

### Build 

- build your home configuration: `make home-update`
- build your system configuration for work laptop (Thinkpad p53): `make sys-update-wl`
- build your system configuration for personal desktop (AMD): `make sys-update-pd`

- upgrade flake dependencies: `make flake-upgrade`

### Remove generations 

- user generations: `make clean`
- system generations: `make clean-su`
- optimise packages: `make deduplicate`

### Show all generations
- `make show-gen`

## Acknowledgments

This configuration structure was inspired by contributions from the Nix community:

- [wimpysworld](https://github.com/wimpysworld/nix-config)
- [ryan4yin](https://github.com/ryan4yin/nix-config)

### References 

This section helped me better understand Nix package manager and Nix language.
Please have a read on them!

#### Jumpstart for using flakes && home-manager

I highly recommend that you read and follow this guide for migrating your initial `configuration.nix` to flakes/home-manager. It's easy to understand without any technical jargon and gets straight to the point.

- [simple-homemanager](https://github.com/evertras/simple-homemanager)

#### Docs
- [ Nixpills ]( https://nixos.org/guides/nix-pills )
- [ Nix and flakes ]( https://nixos-and-flakes.thiscute.world )
- [ Home manager manual ]( https://nix-community.github.io/home-manager/index.xhtml )
- [ Intro to Nix and NixOS ]( https://nixos-and-flakes.thiscute.world/introduction )

### Packages and  templates
#### Search for Nix packages
- [ Nixpkgs ](https://search.nixos.org/packages) 
- [ MyNixOS ](https://mynixos.com/nixpkgs )

#### Nix cache for storing pre-compiled packaged
- [ NixOS cache ]( https://cache.nixos.org )

#### Template for flakes

- [ Flake parts ]( https://community.flake.parts )
